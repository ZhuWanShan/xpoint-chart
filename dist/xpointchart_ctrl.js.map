{"version":3,"sources":["../src/xpointchart_ctrl.js"],"names":["MetricsPanelCtrl","$","_","moment","XPointChartCtrl","$scope","$injector","$rootScope","panel","statisticName","spinTemplate","xpointId","events","on","onRefresh","bind","onInitEditMode","sizeChangeMonitorInitialized","sizeH","rootPanel","height","sizeW","width","self","css","Math","abs","contentPanel","hide","find","mousedown","mouseup","row","dashboard","rows","indexOf","col","panels","myParent","innerWidth","isPending","length","target","insertBefore","show","id","remove","addEditorTab","editorTabs","pop","ONE_HOUR","ONE_DAY","param","forEach","templateSrv","variables","it","name","value","current","text","timeRange","range","from","to","parseInt","toDate","getTime","size","replace","scopedVars","stats","ctx","context","el","createChartPanel","isEqual","_stats","chart","undefined","pending","statsLocation","console","log","requirejs","create","e","html","complete","_context","onContextChange","hook","func","span","type","format","url","genUrl","ajax","dataType","success","error","transformer","token","XP","paramString","window","location","protocol","host","initSizeChangeMonitor","scheduler","clearTimeout","setTimeout","refreshChart","templateUrl"],"mappings":"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","file":"xpointchart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from \"app/plugins/sdk\";\nimport $ from 'jquery';\nimport _ from 'lodash'\nimport moment from 'moment'\n\nexport class XPointChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n\n    if (!this.panel.statisticName) {\n      this.panel.statisticName = 'test'\n    }\n\n    this.spinTemplate = \"<span id='spin_\"\n      + this.xpointId\n      + \"' class='panel-loading'><i class='fa fa-spinner fa-spin'></i></span>\";\n\n    this.events.on('refresh', this.onRefresh.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  initSizeChangeMonitor(){\n    if(!this.sizeChangeMonitorInitialized){\n      this.sizeH = this.rootPanel().height();\n      this.sizeW = this.rootPanel().width();\n      let self = this;\n      this.rootPanel()\n        .css(\"-moz-transition\", \"width 0.01s, height 0.01s\")\n        .css(\"-webkit-transition\", \"width 0.01s, height 0.01s\")\n        .css(\"-o-transition:width\", \"width 0.01s, height 0.01s\")\n        .css(\"transition\", \"width 0.01s, height 0.01s\")\n        .on(\"webkitTransitionEnd transitionend oTransitionEnd\", function () {\n          if(\n            Math.abs(self.sizeH - self.rootPanel().height()) > 1\n            || Math.abs(self.sizeW - self.rootPanel().width()) > 1\n          ){\n            self.contentPanel().hide();\n            self.onRefresh();\n          }\n\n        });\n      this.rootPanel().find('.resize-panel-handle')\n        .mousedown(function () {\n          self.contentPanel().hide();\n        })\n        .mouseup(function () {\n          self.onRefresh();\n        });\n      this.sizeChangeMonitorInitialized = true;\n    }\n  }\n\n  rootPanel(){\n    let row = this.dashboard.rows.indexOf(this.row);\n    let col = this.row.panels.indexOf(this.panel);\n    return $($($($(\".dash-row\")[row]).find(\".panel\")[col]));\n  }\n\n  contentPanel(){\n    return this.rootPanel().find('.panel-content');\n  }\n\n  createChartPanel(){\n    let myParent = this.contentPanel();\n\n    let panel = myParent.find(\".graph-canvas-wrapper\");\n    panel.height(this.rootPanel().find(\".panel-container\").height() - 20);\n    panel.width(this.rootPanel().find(\".panel-container\").innerWidth() - 20);\n\n    return panel;\n  }\n\n  pending(){\n    if(!this.isPending){\n      if($('#spin_' + this.xpointId).length < 1){\n        let target = this.rootPanel().find(\".panel-loading\");\n        $(this.spinTemplate).insertBefore(target);\n      }\n      this.isPending = true;\n    }\n  }\n\n  complete(){\n    this.contentPanel().show();\n    let id = '#spin_' + this.xpointId;\n    $(id).remove();\n    this.sizeH = this.rootPanel().height();\n    this.sizeW = this.rootPanel().width();\n    this.isPending = false;\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/xpoint-chart/editor.html');\n    this.editorTabs[1] = this.editorTabs[this.editorTabs.length - 1];\n    this.editorTabs.pop();\n  }\n\n  context(){\n    let self = this;\n    let ONE_HOUR = 3600 * 1000;\n    let ONE_DAY =  84000 * 1000;\n\n    let param = {};\n\n    _.forEach(this.templateSrv.variables, function(it){\n      param[it.name] = {\n        value: it.current.value,\n        text: it.current.text\n      }\n    });\n\n    let timeRange = this.range;\n\n    if(timeRange && timeRange.from && timeRange.to){\n      timeRange.from = parseInt(timeRange.from / ONE_HOUR) * ONE_HOUR;\n      timeRange.to = parseInt(timeRange.to / ONE_HOUR) * ONE_HOUR;\n    }else{\n      timeRange.to = parseInt(moment().toDate().getTime() / ONE_HOUR) * ONE_HOUR;\n      timeRange.from = timeRange.to - ONE_DAY * 7\n    }\n\n    return {\n      param: param,\n      range: timeRange,\n      size: {\n        height: self.sizeH,\n        width: self.sizeW\n      }\n    };\n  }\n\n  stats(){\n    return this.templateSrv.replace(this.panel.statisticName, this.panel.scopedVars, 'pipe');\n  }\n\n  refreshChart() {\n    let stats =  this.stats();\n    let ctx = this.context();\n    let el = this.createChartPanel()[0];\n    let self  = this;\n\n    if(!_.isEqual(self._stats, stats) || self.chart == undefined){\n      self.pending();\n      self._stats = stats;\n      let statsLocation = 'chart/' + self._stats;\n\n\n      if(!_.isEqual(self._stats, stats)) {\n        console.log(\"Stats Changed, from \" + self._stats + \" to \" + stats);\n      }else{\n        console.log(\"First Time init \" + self._stats);\n      }\n\n      requirejs([statsLocation], function (chart) {\n        try{\n        self.chart = chart(self, el);\n        self.chart.create(ctx);\n        }catch (e){\n          console.log(e);\n          $(el).html(\"Faild to Load \" + stats);\n          self.complete();\n        }\n      });\n\n\n    }else if(!_.isEqual(self._context, ctx)){\n      self.chart.onContextChange(ctx, self._context);\n      self._context = ctx;\n    }else {\n      self.chart.onContextChange(ctx, self._context);\n      console.log(\"Nothing Changed\")\n    }\n  }\n\n  fetchData(hook, func, param, span, type, format) {\n    let url = this.genUrl(func, param, span, type, format);\n    $.ajax({\n      url : url,\n      dataType: \"json\",\n      success: hook? hook.success : undefined,\n      error: hook? hook.error: undefined\n    });\n  }\n\n  genUrl(func, param, span, type, format){\n    var target = 'json';\n    var transformer = \"table\";\n    var token = XP.token();\n\n    if(type){\n      target = type\n    }\n\n    if(format){\n      transformer = format\n    }\n\n    let paramString =  $.param({\n      func : func,\n      \"func-param\": param,\n      token: token,\n      from: span.from,\n      to: span.to,\n      format: transformer\n    }, true);\n    return window.location.protocol + \"//\" + window.location.host + \"/data/\" + target + \"?\" + paramString\n  }\n\n  changeStatistic(){\n    this._stats = null;\n    this.onRefresh()\n  }\n\n  onRefresh() {\n    this.pending();\n    this.initSizeChangeMonitor();\n    if(this.scheduler){\n      clearTimeout(this.scheduler);\n    }\n    this.scheduler = setTimeout(this.refreshChart.bind(this), 1500);\n  }\n\n}\n\nXPointChartCtrl.templateUrl = 'module.html';\n"]}